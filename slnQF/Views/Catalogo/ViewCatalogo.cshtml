
@{
    ViewBag.Title = "ViewCatalogo";
    Layout = "~/Views/Shared/_MyLayout.cshtml";
}
 


<div class="content-wrapper">

    <!-- Content Header (Page header) -->
    <section class="content-header">

        <h1>

            <label id="lbl_titulo">@Model.tituloPagina</label>
            <small>Version 1.0</small>
        </h1>
        <ol class="breadcrumb">
            <li class="active"><a href="#"><i class="fa fa-dashboard"></i><label id="lbl_breadcumb"> </label> </a></li>

        </ol>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <style>
            .loader {
                position: fixed;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                z-index: 9999;
                background: url('../../img/page-loader.gif') 50% 50% no-repeat rgb(249,249,249);
            }
        </style>
        <script type="text/javascript">
                    $(window).load(function() {
	                    $(".loader").fadeOut("slow");
                    })
        </script>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="loader"></div>
        <div class="row" id="divRegresa">
            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title"><label id="lb_estadtitulo"></label></h3>
                    <div class="box-tools pull-right">
                        <!--<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>-->

                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body">

                    @{


                        WebGrid grid = new WebGrid(Model.ItemsCatalogo, canPage: false, selectionFieldName: "selectedRow", ajaxUpdateContainerId: "gridContent");
                        WebGrid grid2 = new WebGrid(Model.ItemsAcceso, canPage: false, selectionFieldName: "selectedRow", ajaxUpdateContainerId: "gridContentAcceso");
                        WebGrid grid3 = new WebGrid(Model.ItemsPermisoPerfil, canPage: false, selectionFieldName: "selectedRow", ajaxUpdateContainerId: "gridContentPermisosPerfil");
                    }
                    <label ID="lblcatalogo" style="display:none">@Model.Catalogo</label>
                    <label ID="lblVerAcciones" style="display:none">@Model.VerAcciones</label>

                    <label ID="lblVerPermisos" style="display:none">@Model.VerPermisos</label>
                    <br />
                    
                    <div id="divNuevo">
                        <h4><a href="#" data-toggle="modal" data-target="#creaCatalogo" class="glyphicon glyphicon-plus">NUEVO</a></h4>
                    </div>
                    

                    <div id="gridContent">

                        @grid.GetHtml(htmlAttributes: new { width = "100%" },
                                    mode: WebGridPagerModes.All,

                                        columns: grid.Columns(
                                        /*grid2.Column(header: "Seleccionar", format: @<text><input type="checkbox" name="selectedrows" value="item.linenum" /></text>),*/
                                        grid.Column(header: "Editar", format: @<text><a href="#" data-toggle="modal" data-target="#ediCatalogo" class="glyphicon glyphicon-edit edit-item" id="@item.id"></a></text>),
                                        grid.Column("id", "ID", null, "text-center", false),
                                        grid.Column("nombre", "DESCRIPCION", null, "text-center", false),
                                        grid.Column("id_estado", "id_estado", null, "text-center", false),
                                        grid.Column("estado", "ESTADO", null, "text-center", false),
                                        grid.Column("fecha", "FECHA CREACION", null, "text-center", false),
                                        grid.Column("responsable", "RESPONSABLE", null, "text-center", false),
                                        grid.Column(header: "", format: @<text><button id="a" data-toggle="modal" data-target="#modAsignaAcceso" class="accesos-click">ACCESOS</button></text>),
                                        grid.Column(header: "", format: @<text><button id="p" data-toggle="modal" data-target="#modAsignaPermisos" class="permisos-click">PERMISOS</button></text>)
                                        )
                                        )



                    </div>

                </div>
            </div>
            <div id="modAsignaPermisos" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>-->
                            <h4 class="modal-title"><label ID="tituloModPermisos" Text=""></label> </h4>
                        </div>
                        <div class="modal-body">
                            <div id="divPermisoPerfil">
                                <label id="lblIdPerfilSelec" style="display:none"></label>
                                <table>
                                    <tr>
                                        <td><label>Permisos: </label></td>
                                        <td>@Html.DropDownList("sel_permisos", null, null, new { @class = "form-control", @onchange = "CallChangeSelPerm(this.value)" })</td>
                                    </tr>
                                    <tr>
                                        <td><label>Accesos : </label></td>
                                        <td>@Html.DropDownList("sel_accesos", null, null, new { @class = "form-control" })</td>
                                    </tr>
                                    <tr>
                                        <td colspan="2">
                                            <button id="Button4"
                                                    text="GUARDAR"
                                                    class="btn btn-primary text-center guarda-permiso-perfil-click">
                                                GUARDAR
                                            </button>

                                        </td>

                                    </tr>
                                </table> <br />

                                <div id="gridContentPermisosPerfil">

                                    @grid3.GetHtml(htmlAttributes: new { width = "100%" },
                                    mode: WebGridPagerModes.All,

                                        columns: grid3.Columns(
                                        /*grid2.Column(header: "Seleccionar", format: @<text><input type="checkbox" name="selectedrows" value="item.linenum" /></text>),*/
                                        grid3.Column(header: "", format: @<text><a href="#" class="glyphicon glyphicon-remove elimina-item-perm" id="@item.id_pm"></a></text>),
                                        grid3.Column("id_pm", "ID", null, "text-center", false),
                                        grid3.Column("desc_pm", "Permiso", null, "text-center", false),
                                        grid3.Column("id_ac", "ID", null, "text-center", false),
                                        grid3.Column("desc_ac", "Acceso", null, "text-center", false)
                    /*grid.Column(header: "", format: @<text><button id="a" data-toggle="modal" data-target="#modAsignaAcceso" class="accesos-click">ACCESOS</button></text>),*/

                    )
                    )


                                </div>

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            <div id="creaCatalogo" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>-->
                            <h4 class="modal-title"><label ID="tituloNuevo" Text=""></label> </h4>
                        </div>
                        <div class="modal-body">
                            <label ID="label2" Text=""></label>
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label for="txt_nuevo_descripcion" class="col-sm-4 control-label">DESCRIPCION</label>
                                    <div class="col-sm-8">
                                        <input type="text" id="txt_nuevo_descripcion" class="form-control" placeholder="Descripcion" />

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cerrar</button>
                            <button id="Button2"
                                    text="GUARDAR"
                                    class="btn btn-primary guarda-catalogo">
                                GUARDAR
                            </button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->

            <div id="modAsignaAcceso" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>-->
                            <h4 class="modal-title"><label ID="tituloAsignaAcceso" Text=""></label> </h4>
                        </div>
                        <div class="modal-body">
                            <div id="divAccesosPorPermiso">
                                <label id="lblIdPermisoSelec" style="display:none"></label>
                                <div id="gridContentAcceso">
                                    @grid2.GetHtml(htmlAttributes: new { width = "100%" },
                mode: WebGridPagerModes.All,

                columns: grid2.Columns(

                grid2.Column("id", "ID", null, "text-center", false),
                grid2.Column("acceso", "NOMBRE", null, "text-center", false),

                grid2.Column(" ", format: (item) =>
                {
                    if (item.sw_asocia == "0")
                    {
                        return Html.Raw(string.Format("<text><input type='checkbox' name='selectedrows' value=" + item.id + " /></text>"));
                    }
                    else
                    {
                        return Html.Raw(string.Format("<text><input type='checkbox' name='selectedrows' value=" + item.id + " checked/></text>"));
                    }
                }, style: "text-center", canSort: false)

                )
                )

                                </div>

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cerrar</button>
                            <button id="Button3"
                                    text="GUARDAR"
                                    class="btn btn-primary text-center guarda-acceso-perfil">
                                GUARDAR
                            </button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            <div id="ediCatalogo" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>

                            <h4 class="modal-title"><label ID="tituloEdita" Text="Edita proveedor id."></label> </h4>
                            <label ID="lblEdiIdCatalogo" Text="" style="display:none"></label>
                        </div>
                        <div class="modal-body">
                            <asp:label ID="label4" Text=""></asp:label>
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label for="txt_edita_descripcion" class="col-sm-4 control-label">DESCRIPCION</label>
                                    <div class="col-sm-8">
                                        <input type="text" id="txt_edita_descripcion" class="form-control" placeholder="Descripcion" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="sel_estados" class="col-sm-4 control-label">ESTADO</label>
                                    <div class="col-sm-8">
                                        @Html.DropDownList("sel_estados", null, null, new { @class = "form-control" })

                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cerrar</button>
                            <button id="Button1"
                                    text="GUARDAR"
                                    class="btn btn-primary edita-catalogo">
                                GUARDAR
                            </button>

                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>
</section>
</div>
@section Scripts{

    <script type="text/javascript">
        $(function () {

            $('#gridContent table').append("<tfoot><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tfoot>")

            
            
        });
        initialize();
        function initialize() {
            var v_idcatalogo = 0;
            var columnas = [3];
            if ($("#lblcatalogo").text() == "Perfil") {
                v_idcatalogo = 7;
                columnas.push(7);
            }

            if ($("#lblcatalogo").text() == "Permiso") {
                v_idcatalogo = 8;
                columnas.push(8);
            }

            if ($("#lblcatalogo").text() == "Acceso") {
                v_idcatalogo = 9;
                columnas.push(7);
                columnas.push(8);
            }
            if ($("#lblcatalogo").text() == "Bodega") {
                v_idcatalogo = 15;
                columnas.push(7);
                columnas.push(8);
            }

            $.ajax({
                url: '/Usuario/jsTraeAccesosUser/',
                type: "GET",
                dataType: "JSON",
                data: {},
                async: false,
                success: function (json) {

                   
                    var v_cuentaEditarUs = 0;
                    var v_cuentaGuardaUs = 0;
                    var v_cuentaVerUs = 0;

                    $.each(json, function (j, item2) {

                        if (item2.IDPERMISO == v_idcatalogo && item2.IDACCESO == 3)
                            v_cuentaEditarUs = 1;

                        if (item2.IDPERMISO == v_idcatalogo && item2.IDACCESO == 1)
                            v_cuentaGuardaUs = 1;

                        if (item2.IDPERMISO == v_idcatalogo && item2.IDACCESO == 2)
                            v_cuentaVerUs = 1;


                    });
                    if (v_cuentaEditarUs == 0) {
                        columnas.push(0);
                        columnas.push(7);
                        columnas.push(8);

                    }
                    if (v_cuentaGuardaUs == 0) {
                        $('#divNuevo').hide();
                    }
                    if (v_cuentaVerUs == 0) {
                        $('#gridContent').hide();
                    }
                    

                    $('#gridContent table').DataTable({
                        "paging": false,
                        "lengthChange": false,
                        "searching": true,
                        "ordering": true,
                        "info": true,
                        "autoWidth": true,
                        "scrollX": true,
                        "columnDefs": [
                                        { "class": "hidden", "targets": columnas },
                                        { "class": "text-center", "targets": [0, 1, 2, 3, 4, 5, 6, 7, 8] }
                        ]
                    }
                    );
                },
                error: function (error) { console.log(error); }
            });
           
            $("#tituloNuevo").text("Crear " + $("#lblcatalogo").text());


            $(document).on('click', '.guarda-catalogo', function () {
                var $v_Desc = $('#txt_nuevo_descripcion').val();
                $.ajax({
                    url: '/Catalogo/guardaCatalogo/',
                    type: "POST",
                    dataType: "JSON",
                    data: { descripcion: $v_Desc, catalogo: $("#lblcatalogo").text() },
                    success: function (json) {

                        if (json.ID == 1) {
                            location.reload();
                        } else {
                            swal("Error", json.MENSAJE1 + " " + json.MENSAJE2, "error")
                        }
                       
                    },
                    error: function (error) {
                        
                        swal("Error", error, "error")
                        
                    }
                });
            });

            $(document).on('click', '.edita-catalogo', function () {

                var $v_Desc = $('#txt_edita_descripcion').val();
                $.ajax({
                    url: '/Catalogo/editaCatalogo/',
                    type: "POST",
                    dataType: "JSON",

                    data: { iddesc: $("#lblEdiIdCatalogo").text(), descripcion: $v_Desc, id_estado: $("#sel_estados  option:selected").val(), catalogo: $("#lblcatalogo").text() },
                    success: function (json) {
                        if (json.ID == 1) {
                            location.reload();
                        } else {
                            swal("Error", json.MENSAJE1 + " " + json.MENSAJE2, "error")
                        }

                        
                    },
                    error: function (error) {
                       
                        swal("Error", error, "error")
                        
                    }
                });
            });


            $(document).on('click', '.elimina-item-perm', function () {


                var pd = $(this).prop('id');
                var tr = $(this).parents('tr');
                var $item = $(this).closest("tr");
                var $idperfil = $("#lblIdPerfilSelec").text();
                var $v_idpm = $item.children("td:eq(1)").html();
                var $v_idac = $item.children("td:eq(3)").html();



                $.ajax({
                    url: '/Catalogo/desasociaPermisoPerfil/',
                    type: "POST",
                    dataType: "JSON",
                    data: { idperfil: $idperfil, idpermiso: $v_idpm, idacceso: $v_idac },
                    success: function (json) {

                        if (json.ID == 1) {
                            $item.remove();
                        } else {
                            swal("Error", json.MENSAJE1 + ' ' + json.MENSAJE2, "error")

                        }
                        

                    },
                    error: function (error) { }
                });


            });
            $(document).on('click', '.edit-item', function () {

                /*$('.gridContent table thead tr th:eq(3)').hide();*/

                var pd = $(this).prop('id');
                var tr = $(this).parents('tr');
                var $item = $(this).closest("tr");
                var $v_nombre = $item.children("td:eq(2)").html();
                var $v_estadoId = $item.children("td:eq(3)").html();
                var $v_estado = $item.children("td:eq(4)").html();
                var $v_fecha = $item.children("td:eq(5)").html();
                var $v_responsable = $item.children("td:eq(6)").html();


                $("#tituloEdita").text("Modificar " + $("#lblcatalogo").text() + " ID: " + pd);
                $("#lblEdiIdCatalogo").text(pd);
                $("#txt_edita_descripcion").val($v_nombre);
                $("#sel_estados").val($v_estadoId);
                /*
                $.ajax({
                    url: '/Produccion/SeleccionItemsOrdenProd/',
                    type: "POST",
                    dataType: "JSON",
                    data: { docentry: $v_docentry },
                    success: function (json) {


                    },
                    error: function (error) { }
                });
                */
            });

            $(document).on('click', '.accesos-click', function () {

                /*$('.gridContent table thead tr th:eq(3)').hide();*/

                var tr = $(this).parents('tr');
                var $item = $(this).closest("tr");
                var $v_id = $item.children("td:eq(1)").html();

                $("#tituloAsignaAcceso").text("Asociar accesos a permiso id: " + $v_id);
                $("#lblIdPermisoSelec").text($v_id);
                $("#gridContentAcceso tbody").empty();
                $.ajax({
                    url: '/Catalogo/traeAccesosPorPermiso/',
                    type: "POST",
                    dataType: "JSON",
                    data: { id: $v_id },
                    success: function (json) {

                        $.each(json, function (j, item2) {
                            var $v_checked = "";
                            if (item2.sw_asocia == "1") {
                                $v_checked = "checked";
                            } else {
                                $v_checked = "";
                            }
                            var newrow = '<tr>' +
                               '<td class="text-center">' + item2.id + '</td>' +
                               '<td class="text-center">' + item2.acceso + '</td>' +

                                '<td class="text-center">' + '<input type="checkbox" class="checkItem" name="selectedrows" value="' + item2.id + '" id="check' + item2.id + '"  ' + $v_checked + ' />' + '</td>' +
                                '</tr>';

                            $("#gridContentAcceso tbody").append(newrow);
                        })


                    },
                    error: function (error) { }
                });

            });

            $(document).on('click', '.permisos-click', function () {

                /*$('.gridContent table thead tr th:eq(3)').hide();*/

                var tr = $(this).parents('tr');
                var $item = $(this).closest("tr");
                var $v_id = $item.children("td:eq(1)").html();
                $("#lblIdPerfilSelec").text($v_id);
                $("#tituloModPermisos").text("Permisos de perfil " + $item.children("td:eq(2)").html());

                $("#gridContentPermisosPerfil tbody").empty();
                $.ajax({
                    url: '/Catalogo/consultaPermisosPerfil/',
                    type: "POST",
                    dataType: "JSON",
                    data: { idpermiso: $v_id },
                    success: function (json) {
                        $.each(json, function (j, item2) {

                            var newrow = '<tr>' +
                                 '<td class="text-center"><a href="#" class="glyphicon glyphicon-remove elimina-item-perm" id="1"></a></td>' +
                               '<td class="text-center">' + item2.id_pm + '</td>' +
                               '<td class="text-center">' + item2.desc_pm + '</td>' +
                                '<td class="text-center">' + item2.id_ac + '</td>' +
                                 '<td class="text-center">' + item2.desc_ac + '</td>' +

                                '</tr>';

                            $("#gridContentPermisosPerfil tbody").append(newrow);
                        });

                    },
                    error: function (error) { console.log(error); }
                });

            });

            $(document).on('click', '.guarda-acceso-perfil', function () {
                var tablas = [];

                var listOfObjects = [];


                $("#gridContentAcceso tbody tr").each(function (index) {
                    var campo1, campo2, campo3, campo4;


                    $(this).children("td").each(function (index2) {

                        var v_campo4, v_campo5;
                        $(this).find("input").each(function () {
                            v_campo4 = $("#" + this.id).is(":checked");
                        })

                        if (v_campo4 == false) {
                            v_campo5 = "0";
                        } else {
                            v_campo5 = "1";
                        }

                        switch (index2) {
                            case 0: campo1 = $(this).text();
                                break;
                            case 1: campo2 = $(this).text();
                                break;
                            case 2: campo3 = v_campo5;
                                break;
                        }




                        //$(this).css("background-color", "#ECF8E0");
                    })


                    var obj = new Object();
                    obj.id = campo1;
                    obj.acceso = campo2;
                    obj.sw_asocia = campo3;
                    listOfObjects.push(obj);
                    //alert(campo1 + ' - ' + campo2 + ' - ' + campo3 + ' - ' + campo4);


                })

                var jsonString = JSON.stringify(listOfObjects);

                $.ajax({
                    url: '/Catalogo/grabaAccesos/',
                    type: "POST",
                    dataType: "JSON",
                    data: { permiso: $("#lblIdPermisoSelec").text(), listastr: jsonString },
                    success: function (json) {
                          if (json.ID == 1) {
                              swal("Informacion", json.MENSAJEPOP, "success")
                        } else {
                              swal("Error", json.MENSAJEPOP, "error")

                        }
                       

                    },
                    error: function (error) { }
                });


            });

            $(document).on('click', '.guarda-permiso-perfil-click', function () {

                /*$('.gridContent table thead tr th:eq(3)').hide();*/

                var $idperfil = $("#lblIdPerfilSelec").text();
                var $codigoPermiso = $("#sel_permisos option:selected").val();
                var $codigoAcceso = $("#sel_accesos option:selected").val();


                $.ajax({
                    url: '/Catalogo/asociaPermisoPerfil/',
                    type: "POST",
                    dataType: "JSON",
                    data: { idperfil: $idperfil, idpermiso: $codigoPermiso, idacceso: $codigoAcceso },
                    success: function (json) {
                        if (json.ID == 1) {
                            var newrow = '<tr>' +
                            '<td class="text-center"><a href="#" class="glyphicon glyphicon-remove elimina-item-perm" id="1"></a></td>' +
                           '<td class="text-center">' + $codigoPermiso + '</td>' +
                           '<td class="text-center">[' + $codigoPermiso + ']' + $("#sel_permisos option:selected").text() + '</td>' +
                            '<td class="text-center">' + $codigoAcceso + '</td>' +
                             '<td class="text-center">[' + $codigoAcceso + ']' + $("#sel_accesos option:selected").text() + '</td>' +

                            '</tr>';
                            $("#gridContentPermisosPerfil tbody").append(newrow);

                        } else {
                           

                            swal("Error", json.MENSAJE1 + ' ' + json.MENSAJE2, "error")
                           
                        }

                    },
                    error: function (error) { }
                });

            });

        };


        function CallChangeSelPerm() {



            var $codigoPermiso = $("#sel_permisos option:selected").val();


            $.ajax({
                url: '/Catalogo/traeSELAccesosPorPermiso/',
                type: "POST",
                dataType: "JSON",
                data: { id: $codigoPermiso },
                success: function (json) {
                    $('#sel_accesos').empty();
                    $.each(json, function (i, item) {

                        $('#sel_accesos').append($('<option>', {
                            value: item.id,
                            text: item.value
                        }));

                    })
                },
                error: function (error) { }
            });
        }
        function llenaCombo() {



            $.ajax({
                url: '/Catalogo/traeComboEstado',
                type: "GET",
                dataType: "JSON",
                data: {},
                success: function (json) {
                    $('#sel_estados').empty();
                    $.each(json, function (i, item) {

                        $('#sel_estados').append($('<option>', {
                            value: item.id,
                            text: item.value
                        }));
                    })
                },
                error: function (error) { }
            });
        }


    </script>
}
